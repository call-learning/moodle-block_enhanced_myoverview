define ("block_enhanced_myoverview/view",["jquery","block_myoverview/repository","core/paged_content_factory","core/pubsub","core/custom_interaction_events","core/notification","core/templates","core_course/events","block_myoverview/selectors","core/paged_content_events","core/ajax"],function(a,b,c,d,e,f,g,h,i,j,k){var l=Object.assign({},b);l.getEnrolledCoursesByTimeline=function(a){var b=k.call([{methodname:"block_enhanced_myoverview_get_enrolled_courses_by_timeline_classification",args:a}])[0];return b};var m={COURSE_REGION:"[data-region=\"course-view-content\"]",ACTION_HIDE_COURSE:"[data-action=\"hide-course\"]",ACTION_SHOW_COURSE:"[data-action=\"show-course\"]",ACTION_ADD_FAVOURITE:"[data-action=\"add-favourite\"]",ACTION_REMOVE_FAVOURITE:"[data-action=\"remove-favourite\"]",FAVOURITE_ICON:"[data-region=\"favourite-icon\"]",ICON_IS_FAVOURITE:"[data-region=\"is-favourite\"]",ICON_NOT_FAVOURITE:"[data-region=\"not-favourite\"]",PAGED_CONTENT_CONTAINER:"[data-region=\"page-container\"]"},n={COURSES_CARDS:"block_myoverview/view-cards",COURSES_LIST:"block_myoverview/view-list",COURSES_SUMMARY:"block_myoverview/view-summary",NOCOURSES:"core_course/no-courses"},o={GROUPING_ALLINCLUDINGHIDDEN:"allincludinghidden",GROUPING_ALL:"all",GROUPING_INPROGRESS:"inprogress",GROUPING_FUTURE:"future",GROUPING_PAST:"past",GROUPING_FAVOURITES:"favourites",GROUPING_HIDDEN:"hidden"},p=[12,24,48,96,0],q=[],r=0,s=0,t=0,u=null,v=function(a){var b=a.find(i.courseView.region);return{display:b.attr("data-display"),grouping:b.attr("data-grouping"),sort:b.attr("data-sort"),displaycategories:b.attr("data-displaycategories"),customfieldname:b.attr("data-customfieldname"),customfieldvalue:b.attr("data-customfieldvalue"),additionalfilter:b.attr("data-additionalfilter")}},w={ignoreControlWhileLoading:!0,controlPlacementBottom:!0,persistentLimitKey:"block_myoverview_user_paging_preference"},x=function(a,b){return l.getEnrolledCoursesByTimeline({offset:r,limit:b,classification:a.grouping,sort:a.sort,customfieldname:a.customfieldname,customfieldvalue:a.customfieldvalue,additionalfilter:a.additionalfilter})},y=function(a,b){return a.find(m.FAVOURITE_ICON+"[data-course-id=\""+b+"\"]")},z=function(a,b){return a.find("[data-region=\"paged-content-page\"][data-page=\""+b+"\"]")},A=function(a){return a.attr("data-course-id")},B=function(a,b){var c=y(a,b),d=c.find(m.ICON_IS_FAVOURITE);d.addClass("hidden");d.attr("aria-hidden",!0);var e=c.find(m.ICON_NOT_FAVOURITE);e.removeClass("hidden");e.attr("aria-hidden",!1)},C=function(a,b){var c=y(a,b),d=c.find(m.ICON_IS_FAVOURITE);d.removeClass("hidden");d.attr("aria-hidden",!1);var e=c.find(m.ICON_NOT_FAVOURITE);e.addClass("hidden");e.attr("aria-hidden",!0)},D=function(a,b){return a.find("[data-action=\"add-favourite\"][data-course-id=\""+b+"\"]")},E=function(a,b){return a.find("[data-action=\"remove-favourite\"][data-course-id=\""+b+"\"]")},F=function(a,b){var c=E(a,b),e=D(a,b);N(b,!0).then(function(g){if(g){d.publish(h.favourited,b);c.removeClass("hidden");e.addClass("hidden");C(a,b)}else{f.alert("Starring course failed","Could not change favourite state")}}).catch(f.exception)},G=function(a,b){var c=E(a,b),e=D(a,b);N(b,!1).then(function(g){if(g){d.publish(h.unfavorited,b);c.addClass("hidden");e.removeClass("hidden");B(a,b)}else{f.alert("Starring course failed","Could not change favourite state")}}).catch(f.exception)},H=function(a,b){return a.find("[data-action=\"hide-course\"][data-course-id=\""+b+"\"]")},I=function(a,b){return a.find("[data-action=\"show-course\"][data-course-id=\""+b+"\"]")},J=function(a,b){var c=H(a,b),d=I(a,b),e=v(a);L(b,!0);if(e.grouping!=o.GROUPING_ALLINCLUDINGHIDDEN){M(a,b)}c.addClass("hidden");d.removeClass("hidden")},K=function(a,b){var c=H(a,b),d=I(a,b),e=v(a);L(b,null);if(e.grouping!=o.GROUPING_ALLINCLUDINGHIDDEN){M(a,b)}c.removeClass("hidden");d.addClass("hidden")},L=function(a,b){if(!1===b){b=null}return l.updateUserPreferences({preferences:[{type:"block_myoverview_hidden_course_"+a,value:b}]})},M=function(b,d){var e=b.find("[data-region=\"paging-bar\"]"),h=parseInt(e.attr("data-active-page-number")),i=q[h],j=i.courses.reduce(function(a,b){if(d!=b.id){a.push(b)}return a},[]);if(q[h+1]!=void 0){var k=q[h+1].courses.slice(0,1);q.forEach(function(b,c){if(c>h){var d=[];if(q[c+1]!=void 0){d=q[c+1].courses.slice(0,1)}q[c].courses=a.merge(q[c].courses.slice(1),d)}});j=a.merge(j,k)}if(s==h+1&&0==q[h+1].courses.length){var l=b.find("[data-region=\"paged-content-container\"]");c.resetLastPageNumber(a(l).attr("id"),h)}q[h].courses=j;r--;var m=z(b,h);O(b,q[h]).then(function(a,b){return g.replaceNodeContents(m,a,b)}).catch(f.exception);q.forEach(function(a,c){if(c>h){var d=z(b,c);d.remove()}})},N=function(a,b){return l.setFavouriteCourses({courses:[{id:a,favourite:b}]}).then(function(c){if(0==c.warnings.length){q.forEach(function(c){c.courses.forEach(function(d,e){if(d.id==a){c.courses[e].isfavourite=b}})});return!0}else{return!1}}).catch(f.exception)},O=function(a,b){var c=v(a),d="";if("card"==c.display){d=n.COURSES_CARDS}else if("list"==c.display){d=n.COURSES_LIST}else{d=n.COURSES_SUMMARY}b.courses=b.courses.map(function(a){a.showcoursecategory="on"==c.displaycategories?!0:!1;return a});if(b.courses.length){return g.render(d,{courses:b.courses})}else{var e=a.find(i.courseView.region).attr("data-nocoursesimg");return g.render(n.NOCOURSES,{nocoursesimg:e})}},P=function(a){this.find(i.courseView.region).attr("data-paging",a)},Q=function(a,b){var c=b+j.SET_ITEMS_PER_PAGE_LIMIT;d.subscribe(c,P.bind(a))},R=function(b){u="block_myoverview_"+b.attr("id")+"_"+Math.random();var d=parseInt(b.find(i.courseView.region).attr("data-paging"),10),e=p.map(function(a){var b=!1;if(a==d){b=!0}return{value:a,active:b}}),h=parseInt(b.find(i.courseView.region).attr("data-totalcoursecount"),10);e=e.filter(function(a){return a.value<h||0===a.value});var j=v(b),k=a.extend({},w);k.eventNamespace=u;var l=c.createWithLimit(e,function(c,d){var e=[];c.forEach(function(c){var g=c.pageNumber,h=0<c.limit?c.limit:0;if(t!=h){q=[];r=0;s=0}if(s==g){d.allItemsLoaded(s);e.push(O(b,q[g]));return}t=h;if(q[g+1]==void 0){if(q[g]==void 0){h*=2}}var i=x(j,h).then(function(e){var f=e.courses,h=0,i=[];if(q[g]!=void 0){i=q[g].courses;var j=i.length;if(j<c.limit){h=c.limit-j;i=a.merge(q[g].courses,f.slice(0,h))}}else{h=c.limit||!1;i=0<c.limit?f.slice(0,c.limit):f}q[g]={courses:i};var k=!1!==h?f.slice(h,f.length):[];if(k.length){q[g+1]={courses:k}}if(q[g].courses.length<c.limit||!k.length){s=g;d.allItemsLoaded(g)}else if(q[g+1]!=void 0&&q[g+1].courses.length<c.limit){s=g+1}r=e.nextoffset;return O(b,q[g])}).catch(f.exception);e.push(i)});return e},k);l.then(function(a,c){Q(b,u);return g.replaceNodeContents(b.find(i.courseView.region),a,c)}).catch(f.exception)},S=function(b){e.define(b,[e.events.activate]);b.on(e.events.activate,m.ACTION_ADD_FAVOURITE,function(c,d){var e=a(c.target).closest(m.ACTION_ADD_FAVOURITE),f=A(e);F(b,f);d.originalEvent.preventDefault()});b.on(e.events.activate,m.ACTION_REMOVE_FAVOURITE,function(c,d){var e=a(c.target).closest(m.ACTION_REMOVE_FAVOURITE),f=A(e);G(b,f);d.originalEvent.preventDefault()});b.on(e.events.activate,m.FAVOURITE_ICON,function(a,b){b.originalEvent.preventDefault()});b.on(e.events.activate,m.ACTION_HIDE_COURSE,function(c,d){var e=a(c.target).closest(m.ACTION_HIDE_COURSE),f=A(e);J(b,f);d.originalEvent.preventDefault()});b.on(e.events.activate,m.ACTION_SHOW_COURSE,function(c,d){var e=a(c.target).closest(m.ACTION_SHOW_COURSE),f=A(e);K(b,f);d.originalEvent.preventDefault()})},T=function(b){b=a(b);q=[];s=0;r=0;R(b);if(!b.attr("data-init")){S(b);b.attr("data-init",!0)}},U=function(a){if(0<q.length){q.forEach(function(b,c){var d=z(a,c);O(a,b).then(function(a,b){return g.replaceNodeContents(d,a,b)}).catch(f.exception)})}else{T(a)}};return{init:T,reset:U}});
//# sourceMappingURL=view.min.js.map
